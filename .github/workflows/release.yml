name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  create-tag:
    name: Create Tag (Manual Trigger)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [create-tag]
    # Skip needs if triggered by tag push
    continue-on-error: ${{ github.event_name == 'push' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake
      
      - name: Build firmware
        run: |
          mkdir build
          cd build
          cmake ..
          make -j$(nproc)
      
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            build/I2Console.uf2
            build/I2Console.elf
            build/I2Console.bin
          body: |
            ## I2Console ${{ steps.version.outputs.tag }}
            
            ### Firmware
            - `I2Console.uf2` - Flash to RP2350-GEEK (drag-and-drop or picotool)
            - `I2Console.elf` - Debug symbols
            - `I2Console.bin` - Raw binary
            
            ### Installation
            ```bash
            # Method 1: Drag-and-drop
            # Hold BOOTSEL, connect USB, drag I2Console.uf2 to drive
            
            # Method 2: picotool
            picotool load I2Console.uf2
            picotool reboot
            ```
            
            ### ESP-IDF Component
            ```bash
            idf.py add-dependency "metaneutrons/i2console^${{ steps.version.outputs.version }}"
            ```
            
            See [README](https://github.com/metaneutrons/I2Console/blob/main/README.md) for details.

  publish-component:
    name: Publish ESP-IDF Component
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: always() && (needs.build-and-release.result == 'success' || needs.build-and-release.result == 'skipped')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
      
      - name: Install component manager
        run: pip install idf-component-manager
      
      - name: Check component manifest
        working-directory: examples/esp-idf/components/i2console
        run: |
          echo "Checking idf_component.yml syntax..."
          python3 -c "import yaml; yaml.safe_load(open('idf_component.yml'))"
          echo "Component manifest is valid"
      
      - name: Upload component to registry
        working-directory: examples/esp-idf/components/i2console
        env:
          IDF_COMPONENT_API_TOKEN: ${{ secrets.IDF_COMPONENT_API_TOKEN }}
        run: |
          compote component upload --name i2console --namespace metaneutrons --version ${{ steps.version.outputs.version }} --allow-existing
