name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-firmware:
    name: Build I2Console Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake
      
      - name: Build firmware
        run: |
          mkdir build
          cd build
          cmake ..
          make -j$(nproc)
      
      - name: Check build artifacts
        run: |
          ls -lh build/I2Console.uf2
          ls -lh build/I2Console.elf
      
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v5
        with:
          name: firmware
          path: |
            build/I2Console.uf2
            build/I2Console.elf
            build/I2Console.bin

  build-esp-idf-example:
    name: Build ESP-IDF Example
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.3
          target: esp32
          path: examples/esp-idf
      
      - name: Build example
        run: |
          cd examples/esp-idf
          . $IDF_PATH/export.sh
          idf.py build
      
      - name: Upload example artifacts
        uses: actions/upload-artifact@v5
        with:
          name: esp-idf-example
          path: examples/esp-idf/build/*.bin

  validate-component:
    name: Validate ESP-IDF Component
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Install component manager
        run: pip install idf-component-manager
      
      - name: Check component manifest
        working-directory: examples/esp-idf/components/i2console
        run: |
          echo "Checking idf_component.yml syntax..."
          python3 -c "import yaml; yaml.safe_load(open('idf_component.yml'))"
          echo "Component manifest is valid"
